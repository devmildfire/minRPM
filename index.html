<!DOCTYPE html>

<div 
  id="aads-ad-container-1623" 
  data-src="//dynamic.a-ads.com/1623?size=234x60"
  data-style="width:234px; height:60px; border:0px; padding:0; overflow:hidden; background-color: transparent;"
  data-fallback="<!-- Here goes your fallback HTML code -->"
></div>

<script>
  (function initAds() {

    const containers = document.querySelectorAll('div[id^="aads-ad-container-"]');
    
    containers.forEach(container => {
      loadAd(container);
    });

    async function loadAd(container) {

      const idParts = container.id.split('-');
      const adUnit = idParts[idParts.length - 1];

      console.log(`[Ad Loader] Loading ad for container ${container.id}`);

      const adUrl = container.dataset.src || `https://dynamic.a-ads.com/${adUnit}?size=${size[0]}x${size[1]}`;

      console.log(`HUB - adUrl is ...  ${adUrl}`);


      const size = adUrl.split('size=').pop().split('x'); 
      console.log(`HUB - size is ...  ${size}`);

      const iframeStyle = container.dataset.style || 'width:300px;height:250px;border:0;padding:0;background:transparent;';
      console.log(`HUB - Style is ...  ${iframeStyle}`);



      const fallbackHtml = container.dataset.fallback || '';

      const iframe = document.createElement('iframe');
      iframe.setAttribute('data-aa', adUnit);
      iframe.style.cssText = iframeStyle;

      try {

        //FOR TEST!!!
        // const absoluteUrl = `https://corsproxy.io/?https://stg-dynamic.a-ads.com/${adUnit}?size=${size[0]}x${size[1]}`

        const absoluteUrl = new URL(adUrl, location.origin).href;
        
        console.log(`HUB - NEW - adUrl is ...  ${absoluteUrl}`);

        const response = await fetch(absoluteUrl);
        let html = await response.text();
              
        if (!html.trim()) throw new Error('Empty ad content');
        
       
        let metaTags = html.match(/<meta[^>]*>/gi) || [];
        console.log("[Ad Loader] Found meta tags:", metaTags);

        let refreshMatch = html.match(/<meta[^>]+content=['"]?(\d+)['"]?[^>]+http-equiv=['"]?refresh['"]/i);
        let refreshTime = refreshMatch ? parseInt(refreshMatch[1], 10) : 0;
        console.log(`[Ad Loader] Extracted refresh time: ${refreshTime} seconds`);

        html = html.replace(/<meta[^>]+http-equiv=['"]?refresh['"][^>]*>/i, '');

        iframe.removeAttribute("src");
        
        container.innerHTML = '';
        container.appendChild(iframe);
        iframe.sandbox = "allow-scripts allow-same-origin allow-popups";
        iframe.srcdoc = html;

        if (refreshTime > 0) {
          setTimeout(() => loadAd(container), refreshTime * 1000);
        }
      } catch (error) {
        console.error(`[Ad Loader] Error in ${container.id}:`, error);
          container.innerHTML = fallbackHtml;
      }
    }
  })();
</script>




<div id="ad-container" style="width:234px;height:60px;"></div>

<script>
    (async function loadAd() {
        console.log("[Ad Loader] Starting ad load...");

        const iframeTemplate = `<iframe data-aa='1623' src='//dynamic.a-ads.com/1623?size=234x60' 
            style='width:234px; height:60px; border:0; padding:0; overflow:hidden; background-color:transparent;'></iframe>`;

        // Extract ad URL safely
        const tempContainer = document.createElement("div");
        tempContainer.innerHTML = iframeTemplate;
        const iframe = tempContainer.firstElementChild;
        if (!iframe) return console.error("[Ad Loader] Error: No iframe found in template");

        let adUrl = iframe.getAttribute("src");

          console.log('BLOG adURL .... ', adUrl);

        if (!adUrl) return console.error("[Ad Loader] Error: No src attribute in iframe");

        adUrl = new URL(adUrl, location.origin).href;
        console.log(`[Ad Loader] Fetching ad from: ${adUrl}`);

        console.log('BLOG - NEW - adURL .... ', adUrl);

        try {
            let html = await (await fetch(adUrl)).text();
            if (!html.trim()) throw new Error("Ad content is empty");

            console.log("[Ad Loader] Ad content fetched successfully.");

            // Log all meta tags for debugging
            let metaTags = html.match(/<meta[^>]*>/gi) || [];
            console.log("[Ad Loader] Found meta tags:", metaTags);

            // Extract refresh time (handles any attribute order)
            let refreshMatch = html.match(/<meta[^>]+content=['"]?(\d+)['"]?[^>]+http-equiv=['"]?refresh['"]/i);
            let refreshTime = refreshMatch ? parseInt(refreshMatch[1], 10) : 0;
            console.log(`[Ad Loader] Extracted refresh time: ${refreshTime} seconds`);

            // Remove meta refresh
            html = html.replace(/<meta[^>]+http-equiv=['"]?refresh['"][^>]*>/i, '');

            // Ensure the iframe does NOT trigger a second request
            iframe.removeAttribute("src");

            // Insert into DOM after src is removed
            document.getElementById('ad-container').innerHTML = "";
            document.getElementById('ad-container').appendChild(iframe);

            // Now set `srcdoc`
            iframe.srcdoc = html;

            console.log("[Ad Loader] Ad inserted into iframe.");

            // Schedule next reload
            if (refreshTime > 0) {
                console.log(`[Ad Loader] Scheduling next refresh in ${refreshTime} seconds.`);
                setTimeout(loadAd, refreshTime * 1000);
            } else {
                console.warn("[Ad Loader] No valid refresh time found. Ad will not auto-reload.");
            }
        } catch (error) {
            console.error("[Ad Loader] Ad loading error:", error);
            document.getElementById('ad-container').innerHTML = 'Fallback ad';
        }
    })();
</script>

